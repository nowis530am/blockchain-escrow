<style>
  #product-registration {
    font-weight: bold;
    color: #253066;
  }

  #search_box {
    width: 300px;
  }
  .mypage-menu-title {
    font-weight: bold;
    font-size: 22px;
    text-align: center;
    padding-bottom: 10px;
    margin: 40px 0 0;
  }
  .mypage-menu {
    width: 20%;
    margin: 0 100px 0 0;
    float: left;
    display: inline-block;
  }
  .nav.nav-pills.nav-stacked {
    font-size: 18px;
  }
  .info-container {
    display: inline-block;
    width: 70%;
    margin: 40px 0 0;
  }
  .info-head {
    font-weight: bold;
    font-size: 24px;
    border-bottom: 2px solid #eee;
    padding-bottom: 9px;
    margin: 5% 0 20px;
  }
  .glyphicon.glyphicon-menu-left {
    margin: 1px 8px 0 0;
    overflow: hidden;
    float: left;
  }
  .product-info-left{
    width: 45%;
    float: left;
    margin: 0 30px 0 0;
    overflow: hidden;
    disply: inline-block;
  }
  #product-img {
    width: 100%;
    height: auto;
    object-fit: cover;
  }
  .product-info-right {
    width: 45%;
    height: auto;
    float: left;
    margin: 0 0 5% 2%;
  }
  .product-info-table {
    width: 100%;
    disply: block;
    overflow: hidden;
    word-break: normal;
    word-wrap: break-word;
  }
  .info-title{
    font-size: 18px;
  }
  .info-content{
    font-size: 16px;
  }

  .table {
    font-size: 16px;
    word-break: normal;
    word-wrap: break-word;
  }
  .buyer-info-list{
    width: 20%;
    text-align: center;
  }
  .payinfo-table-bordered{
    border-top: 0px !important ;
    border-bottom: 3px solid;
  }
  .payinfo-table-nonbordered{
    border-top: 0px !important ;
  }
  .price{
    text-align: right;
  }
  #product-price-total{
    font-weight: bold;
    font-size: 22px;
    color: red;
  }
  #product-payback{
    font-weight: bold;
    font-size: 17px;
    color: green;
  }
  .sales-status {
    width: 20%;
    text-align: center;
  }
  .status-content {
    width: 100%;
  }
  .col-lg-6{
    padding: 0;
  }
</style>

<!-- Begin page content in <body>-->
<div class="container">
  <div class="page-header">
    <h1>This is <b>PURCHASE_DETAILS</b> page.</h1>
  </div>

  <div class="mypage-menu">
    <div class="mypage-menu-title">MY PAGE</div>
    <ul class="nav nav-pills nav-stacked">
      <li role="presentation">
        <a class="nav-link" id="profile-tab" href="/mypage">Profile</a>
      </li>
      <li role="presentation">
        <a class="nav-link" id="salesList-tab" href="/saleslist">Sales List</a>
      </li>
      <li role="presentation" class="active">
        <a class="nav-link" id="purchaseList-tab" href="/purchaselist">Purchase List</a>
      </li>
      <li role="presentation">
        <a class="nav-link" id="wishList-tab" href="/wishlist">Wish List</a>
      </li>
      <li role="presentation">
        <a class="nav-link" id="wallet-tab" href="/wallet">Wallet</a>
      </li>
    </ul>
  </div>

  <div class="info-container">
    <div class="myPurchasedetails">
      <!-- 판매 목록으로 돌아가기 버튼 -->
      <a href="/purchaselist">
        <div class="h2">
          <span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span>
        </div>
      </a>
      <div class="h2">
        <span><b>Purchase Details</b></span>
      </div>

      <div class="info-head">
        Product Info
      </div> <!-- info-head end -->
      <div class="info-body">
        <div class="product-info-left">
          <img id="product-img" src="<%=product.images[0]%>" alt="product-img">
        </div>
        <div class="product-info-right">
          <table class="product-info-table">
            <tbody>
              <!-- Product Name -->
              <tr class="info-title">
                <th>Product Name:</th>
              </tr>
              <tr class="info-content">
                <td id="product-name"><%=product.title%></td>
              </tr>
              <tr>
                <td><br></td> <!--For empty row-->
              </tr>

              <!-- Price -->
              <tr class="info-title">
                <th>Price:</th>
              </tr>
              <tr class="info-content">
                <td id="price"><%=product.price%> ETH</td>
              </tr>
              <tr>
                <td><br></td> <!--For empty row-->
              </tr>

              <!-- Purchase date -->
              <tr class="info-title">
                <th>Purchase date:</th>
              </tr>
              <tr class="info-content">
                <td id="purchase-date"><%=transaction.createdAt%></td>
              </tr>
              <tr>
                <td><br></td> <!--For empty row-->
              </tr>

              <!-- Purchase Number -->
              <tr class="info-title">
                <th>Purchase Number:</th>
              </tr>
              <tr class="info-content">
                <td id="purchase-number"><%=transaction._id%></td>
              </tr>
              <tr>
                <td><br></td> <!--For empty row-->
              </tr>
            </tbody>
          </table>
        </div> <!-- product-info-right end -->
      </div> <!-- info-body end -->

      <!-- 구매 상세에서 구매자 정보는 항상 나오게.. -->
      <div class="info-head">
        Buyer Info
      </div> <!-- info-head end -->
      <div class="info-body">
        <table class="table">
          <tbody>
            <tr>
              <th class="buyer-info-list">구매자</th>
              <td id="buyer-name"><%=transaction.buyer.name%></td>
            </tr>
            <tr>
              <th class="buyer-info-list">연락처</th>
              <td id="buyer-phone"><%=transaction.buyer.phone%></td>
            </tr>
            <tr>
              <th class="buyer-info-list">주소</th>
              <td id="buyer-address"><%=transaction.buyer.address%></td>
            </tr>
            <!-- <tr>
              <th class="buyer-info-list">요청사항</th>
              <td id="buyer-requirement">포장 튼튼하게 해주세요!</td>
            </tr> -->
            <tr>
              <th class="buyer-info-list">구매일자</th>
              <td id="buyer-buydate"><%=transaction.createdAt%></td>
            </tr>
            <tr>
              <td><br></td>
              <td><br></td>
            </tr>
          </tbody>
        </table>
      </div> <!-- info-body end -->

      <div class="info-head">
        Payment information
      </div> <!-- info-head end -->
      <div class="info-body">
        <table class="table">
          <tbody>
            <tr>
              <th class="payinfo-table-bordered" colspan="2">결제수단</th>
            </tr>
            <tr>
              <td>상품 가격</td>
              <td class="price"><span id="product-price"><%=product.price%></span> ETH</td>
            </tr>
            <tr>
              <td class="payinfo-table-nonbordered">페이백 보증금</td>
              <td class="price payinfo-table-nonbordered"><span id="product-payback"><%=product.price%></span> ETH</td>
            </tr>
            <!-- <tr>
              <td class="payinfo-table-nonbordered">배송비</td>
              <td class="price payinfo-table-nonbordered"><span id="delivery-fee">2,500</span>$</td>
            </tr> -->
            <tr>
              <td class="payinfo-table-bordered" colspan="2"><br></td>
            </tr>
            <tr>
              <td><strong>총 결제금액</strong></td>
              <td class="price"><span id="product-price-total"><%=product.price * 2%></span> ETH</td>
            </tr>
            <tr>
              <td class="payinfo-table-bordered"><strong>페이백 반환금액</strong></td>
              <td class="price payinfo-table-bordered">(+<span id="product-payback"><%=product.price%></span> ETH)</td>
            </tr>
            <tr>
              <td colspan="3"><br></td>
            </tr>
          </tbody>
        </table>
      </div> <!-- info-body end -->

      <div class="info-head">
        Purchase status
      </div> <!-- info-head end -->
      <div class="info-body">
        <table class="table">
          <tbody>
            <!-- 대기 -->
            <tr>
              <th class="sales-status">
                입금 대기
                <% if(transaction.state == 'cancel') { %>
                <h4><span class="label label-danger">Fail!</span></h4>
                <% } else { %>
                  <h4><span class="label label-success">Success</span></h4>
                <% } %>
              </th>
              <td class="status-content">
                입금 대기중입니다. 결제를 진행 해주세요.<br>
                취소를 원하시면 '구매 취소'를 눌러주세요.
                <br><br>
                <!-- Button trigger modal -->
                <!-- 물품 결제 버튼 >>> 알림 창 Trigger -->
                <% if(transaction.state == 'cancel') { %>
                <button disabled type="button" class="btn btn-lg btn-primary" data-toggle="modal" data-target="#paymentModal">
                  <span><b>물품 결제</b></span>
                </button>
                <% } else { %>
                <button type="button" class="btn btn-lg btn-primary" data-toggle="modal" data-target="#paymentModal">
                  <span><b>물품 결제</b></span>
                </button>
                <% } %>

                <!-- Modal -->
                <div class="modal fade" id="paymentModal" tabindex="-1" role="dialog" aria-labelledby="paymentModalLabel" aria-hidden="true">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h2 class="modal-title" id="paymentModalLabel"><strong>결제 진행</strong></h2>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <p>
                          물품 결제를 진행합니다.<br>
                          진행을 원하시면 <b>'결제'</b> 버튼을 눌러주세요.<br>
                          아직 결제 진행을 원치 않으면 <b>'닫기'</b> 버튼을 눌러주세요.
                        </p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                        <a href="modal_link_test">
                          <button type="button" class="btn btn-primary">결제</button>
                        </a>
                      </div>
                    </div>
                  </div>
                </div> <!-- modal end -->


                <!-- Button trigger modal -->
                <!-- 구매 취소 버튼 >>> 알림 창 Trigger -->
                <% if(transaction.state == 'cancel') { %>
                <button disabled type="button" class="btn btn-lg btn-danger" data-toggle="modal" data-target="#cancelModal">
                  <span><b>구매 취소</b></span>
                </button>
                <% } else { %>
                <button type="button" class="btn btn-lg btn-danger" data-toggle="modal" data-target="#cancelModal">
                  <span><b>구매 취소</b></span>
                </button>
                <% } %>
                <!-- Modal -->
                <div class="modal fade" id="cancelModal" tabindex="-1" role="dialog" aria-labelledby="cancelModalLabel" aria-hidden="true">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h2 class="modal-title" id="cancelModalLabel"><strong>구매 취소</strong></h2>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <p>
                          정말 구매 취소를 하시겠습니까?<br>
                          구매 취소를 원하시면 <b>'구매 취소'</b> 버튼을 눌러주세요.<br>
                          구매 취소를 원치 않으면 <b>'닫기'</b> 버튼을 눌러주세요.
                        </p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                        <a href="modal_link_test">
                          <button id="btn-order-cancel" type="button" class="btn btn-danger">구매 취소</button>
                        </a>
                      </div>
                    </div>
                  </div>
                </div> <!-- modal end -->

              </td>

            </tr>

            <!-- 주문 처리중 -->
            <tr>
              <th class="sales-status">
                주문 처리중<br>(결제완료)
                <% if(transaction.state == 'start') { %>
                  <h4><span class="label label-primary">In progress</span></h4>
                <% } else if(transaction.state == 'cancel') { %>
                  <h4><span class="label label-danger">Fail!</span></h4>
                <% } else { %>
                  <h4><span class="label label-success">Success</span></h4>
                <% } %>
              </th>
              <td class="status-content">
                결제가 완료되었습니다. <br> 판매자가 발송할 상품을 준비중입니다.
              </td>
            </tr>

            <!-- 배송시작 -->
            <tr>
              <th class="sales-status">
                배송시작 (배송중)
                <% if(transaction.state == 'shipping') { %>
                  <h4><span class="label label-success">Success</span></h4>
                <% } else if(transaction.state == 'cancel') { %>
                  <h4><span class="label label-danger">Fail!</span></h4>
                <% } else if(transaction.state == 'success') { %>
                  <h4><span class="label label-success">Success</span></h4>
                <% } else { %>
                  <h4><span class="label label-default">Waiting</span></h4>
                <% } %>
              </th>
              <td class="status-content">판매자가 물품을 배송하였습니다. 현재 물품이 배송 중입니다..</td>
            </tr>

            <!-- 배송 완료 -->
            <tr>
              <th class="sales-status">
                배송 완료
                <% if(transaction.state == 'shipping') { %>
                  <h4><span class="label label-primary">In Progress</span></h4>
                <% } else if(transaction.state == 'cancel') { %>
                  <h4><span class="label label-danger">Fail!</span></h4>
                <% } else if(transaction.state == 'success') { %>
                  <h4><span class="label label-success">Success</span></h4>
                <% } else { %>
                  <h4><span class="label label-default">Waiting</span></h4>
                <% } %>
              </th>
              <td class="status-content">
                상품이 주문자에게 배송 완료 되었습니다. <br>
                '구매 확정' 버튼을 누르면 <span style="color: green; font-size:18px;"><b>페이백 반환금</b></span>이 입금됩니다.
                <br><br>

                <!-- Button trigger modal -->
                <!-- 구매 확정 버튼 >>> 알림 창 Trigger -->
                <% if(transaction.state == 'shipping') { %>
                <button type="button" class="btn btn-lg btn-primary" data-toggle="modal" data-target="#confirmModal">
                  <span><b>구매 확정</b></span>
                </button>
                <% } else { %>
                <button disabled type="button" class="btn btn-lg btn-primary" data-toggle="modal" data-target="#confirmModal">
                  <span><b>구매 확정</b></span>
                </button>
                <% } %>

                <!-- Modal -->
                <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel" aria-hidden="true">
                  <div class="modal-dialog" role="document">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h2 class="modal-title" id="confirmModalLabel"><strong>구매 확정</strong></h2>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                          <span aria-hidden="true">&times;</span>
                        </button>
                      </div>
                      <div class="modal-body">
                        <p>
                          구매 확정을 진행합니다.<br>
                          진행을 원하시면 <b>'확정'</b> 버튼을 눌러주세요.<br>
                          아직 구매 확정을 원치 않으면 <b>'닫기'</b> 버튼을 눌러주세요.
                        </p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                        <a href="modal_link_test">
                          <button type="button" class="btn btn-primary" id="btn-order-confirm">구매 확정</button>
                        </a>
                      </div>
                    </div>
                  </div>
                </div> <!-- modal end -->


              </td>
            </tr>


            <!-- 거래취소 -->
            <tr>
              <th class="sales-status">
                거래 취소
                <% if(transaction.state == 'cancel') { %>
                  <h4><span class="label label-success">Success</span></h4>
                <% } else { %>
                  <h4><span class="label label-default">Waiting</span></h4>
                <% } %>
              </th>
              <td class="status-content">
                거래가 취소되었습니다.
              </td>
            </tr>

            <!-- 표 마지막줄 테두리 생성 -->
            <tr>
              <td colspan="2"><br></td>
            </tr>
          </tbody>
        </table>
      </div> <!-- info-body end -->



      <!-- 구매 취소 버튼을 눌렀을 때 아래 내용이 떠야함. -->
      <% if(transaction.state == 'cancel') { %>
      <div class="info-head">
        <div class="alert alert-danger" role="alert">
          본 거래는 취소된 거래입니다.
        </div>
        Cancellation
      </div> <!-- info-head end -->

      <div class="info-body">
        <table class="table">
          <tbody>
            <tr>
              <th class="buyer-info-list">구매자</th>
              <td id="buyer-name"><%=transaction.buyer.name%></td>
            </tr>
            <tr>
              <th class="buyer-info-list">구매일자</th>
              <td id="buyer-buydate"><%=transaction.createdAt%></td>
            </tr>
            <!-- <tr>
              <th class="buyer-info-list">취소사유</th>
              <td id="buyer-cancelreason">더 이상 필요하지 않음.</td>
            </tr> -->
            <tr>
              <th class="buyer-info-list">취소일자</th>
              <td id="buyer-canceldate"><%=transaction.updatedAt%></td>
            </tr>
            <tr>
              <th class="buyer-info-list">취소번호</th>
              <td id="buyer-canceldate"><%=transaction._id%></td>
            </tr>
            <tr>
              <td><br></td>
              <td><br></td>
            </tr>
          </tbody>
        </table>
      </div> <!-- info-body end -->

      <!-- 환불 상세 표 -->
      <div class="info-head">
        Refund Specification
      </div> <!-- info-head end -->
      <div class="info-body">
        <table class="table">
          <tbody>
            <tr>
              <th class="payinfo-table-bordered" colspan="4">환불 상세</th>
            </tr>
            <tr>
              <td>상품 취소 금액</td>
              <td class="price"><span id="product-price"><%=product.price%></span> ETH</td>
              <!-- <td>환불 수단</td>
              <td style="text-align: right;">계좌이체 (하나은행)</td> -->
            </tr>
            <tr>
              <td class="payinfo-table-nonbordered">페이백 보증금</td>
              <td class="price payinfo-table-nonbordered"><span id="product-price"><%=product.price%></span> ETH</td>
              <td class="payinfo-table-nonbordered">결제금액환불</td>
              <td class="price payinfo-table-nonbordered"><span id="product-price"><b><%=product.price%></b></span> ETH</td>
            </tr>
            <tr>
              <td class="payinfo-table-nonbordered"></td>
              <td class="price payinfo-table-nonbordered"></td>
              <td class="payinfo-table-nonbordered">페이백 보증금 환불</td>
              <td class="price payinfo-table-nonbordered"><span id="product-price"><b><%=product.price%></b></span> ETH</td>
            </tr>
            <tr>
              <td class="payinfo-table-bordered" colspan="4"><br></td>
            </tr>
            <tr>
              <td colspan="2"></td>
              <td><strong>총 환불금액</strong></td>
              <td class="price"><span id="product-price-total"><%=product.price%></span> ETH</td>
            </tr>
            <tr>
              <td class="payinfo-table-nonbordered" colspan="4"><br></td>
            </tr>
          </tbody>
        </table>
      </div> <!-- info-body end -->
      <% } %>
      



      
    </div> <!-- myPurchasedetails end -->
  </div> <!-- info-container end -->
</div> <!-- container end -->


<script>
$('#btn-order-confirm').on('click', function(e) {
  e.preventDefault();
  
  $.ajax({
    url: "/api/purchase_confirm",
    type: "post",
    dataType: "json",
    data: {
      productId: "<%=product._id%>"
    },
    beforeSend: function(xhr) {
      $('#btn-order-confirm').text("구매 확정 처리 중입니다...");
    },
    success: function (data) {
      $('#btn-order-confirm').text("구매 확정");
      alert(data.message);
      $('#confirmModal').hide();
      location.reload();
    },
    fail: function () {
      alert("Error");
    }
  });
});

$('#btn-order-cancel').on('click', function(e) {
  e.preventDefault();
  
  $.ajax({
    url: "/api/purchase_cancel",
    type: "post",
    dataType: "json",
    data: {
      productId: "<%=product._id%>"
    },
    beforeSend: function(xhr) {
      $('#btn-order-cancel').text("구매 취소 처리 중입니다...");
    },
    success: function (data) {
      $('#btn-order-cancel').text("구매 취소");
      alert(data.message);
      $('#cancelModal').hide();
      location.reload();
    },
    fail: function () {
      alert("Error");
    }
  });
});
</script>